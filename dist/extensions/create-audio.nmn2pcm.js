/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/create-audio.nmn2pcm.js
*/
!function(e){var t="object"==typeof window&&!!window.document,r=(t?window:Object).Recorder,a=r.i18n;!function(se,e,ue,t){"use strict";var r=function(e){var t=e.texts||[];"string"==typeof t&&(t=[t]);var r=e.sampleRate,a=r;(!a||a<1)&&(a=48e3);var n=e.meterDuration||600,i=e.timbre||2;i<1&&(i=1);var o=e.volume;null==o&&(o=.3),o=Math.max(0,o),o=Math.min(1,o);var l=e.waveType||"";-1==",sine,square,sawtooth,triangle,".indexOf(","+l+",")&&(l=""),l=l||"sine";var s=e.muteDuration;(null==s||s<0)&&50<(s=n/4)&&(s=50);var u=new Int16Array(a*s/1e3),h=e.beginDuration;(null==h||h<0)&&(h=200);var _=new Int16Array(a*h/1e3),v=e.endDuration;(null==v||v<0)&&(v=200);for(var f=new Int16Array(a*v/1e3),m=function(e){return 440/Math.pow(2,e/12)},g=[m(9),m(7),m(5),m(4),m(2),m(0),m(-2)],w={},p=1;p<=7;p++){var c=g[p-1];w[p+"..."]=c/8,w[p+".."]=c/4,w[p+"."]=c/2,w[p]=c,w[p+"'"]=2*c,w[p+"''"]=4*c,w[p+"'''"]=8*c}for(var b=[],M=0,x=9e4,y=0;-1!=r&&y<t.length;y++){for(var D=t[y].split(/[\s\|]+/),d=[],R=0,A=l,I=i,C=o,E=0;E<D.length;E++){var z=D[E];if(z){var T=z.charCodeAt(0);if(T<48||55<T){var q=/^(\w)(?:\((.+)\)|\[(.+)\])*$/.exec(z)||[],F=q[1],q=/\((.+)\)/.exec(z)||[],N=q[1],q=/\[(.+)\]/.exec(z)||[],G=q[1];if("R"==F?(A=l,I=i,C=o):"S"==F?A="sine":"Q"==F?A="square":"A"==F?A="sawtooth":"T"==F?A="triangle":F="",!F||N&&!+N||G&&!+G)throw new Error("Invalid: "+z);N&&(I=+N),G&&(C=o*G)}else{for(var H=z.split(","),O=n,P=0,j=0,B=0,L=0;L<H.length;L++){var Q=H[L].split(""),S={y:Q[0],b:1,t:A,tb:I,vol:C};H[L]=S;for(var $=1;$<Q.length;$++){var c=Q[$];if("'"==c)S.y+="'";else if("."==c)S.y+=".";else if("-"==c)S.b+=1,O+=n;else if("_"==c)S.b/=2,j=1;else{if("*"!=c||B)throw new Error(ue("3RBa::符号[{1}]无效：{2}",0,c,z));S.b+=.5,B=.5,"*"==Q[$+1]&&(S.b-=.25,B=.25,$++)}}P+=S.b}0<P%1&&(j?O*=P/Math.ceil(P):B&&(O+=n*B)),O-=H.length*s;for(var L=0;L<H.length;L++){var S=H[L],A=S.t,I=S.tb,C=S.vol,J=w[S.y]||0;if(!J&&"0"!=S.y)throw new Error(ue("U212::音符[{1}]无效：{2}",0,S.y,z));J*=I;var U=O*S.b/P,W=new Int16Array(Math.round(U/1e3*a));if(J){if(M=Math.max(M,J),x=Math.min(x,J),"sine"==A)for(var Y=2*Math.PI*J/a,p=0;p<W.length;p++){var c=C*Math.sin(Y*p);W[p]=32767*Math.max(-1,Math.min(1,c))}else if("square"==A)for(var Y=a/J,p=0;p<W.length;p++){var c=C*(p%Y<Y/2?1:-1);W[p]=32767*Math.max(-1,Math.min(1,c))}else if("sawtooth"==A)for(var Y=a/J,p=0;p<W.length;p++){var c=C*(p%Y*2/Y-1);W[p]=32767*Math.max(-1,Math.min(1,c))}else if("triangle"==A)for(var Y=a/J,p=0;p<W.length;p++){var Z=(p+Y/4)%Y,c=C*(Z<Y/2?4*Z/Y-1:3-4*Z/Y);W[p]=32767*Math.max(-1,Math.min(1,c))}var k=~~(W.length/a*1e3/4)||1;he(W,a,Math.min(k,10))}var K=u;d.length||(K=_),d.push(K),R+=K.length,d.push(W),R+=W.length}}}}0<R&&(d.push(f),R+=f.length,b.push({buffers:d,size:R}))}b.sort(function(e,t){return t.size-e.size});for(var W=new Int16Array(b[0]&&b[0].size||0),y=0;y<b.length;y++){var S=b[y],d=S.buffers,R=S.size;if(0==y)for(var p=0,V=0;p<d.length;p++){var X=d[p];W.set(X,V),V+=X.length}else{var ee=(W.length-R)/a*1e3;if(10<ee)throw new Error(ue("7qAD::多个音时必须对齐，相差{1}ms",0,ee));for(var p=0,V=0;p<d.length;p++)for(var X=d[p],te=0;te<X.length;te++){var re,ae=W[V],ne=X[te];re=ae<0&&ne<0?ae+ne-ae*ne/-32767:ae+ne-ae*ne/32767,W[V++]=re}}}var U=Math.round(W.length/a*1e3),ie=[],oe=~~(2*M);if(M&&a<oe){var le="sampleRate["+a+"] should be greater than "+oe;ie.push(le),se.CLog("NMN2PCM: "+le,3)}return{pcm:W,duration:U,warns:ie,set:{texts:t,sampleRate:a,timbre:i,meterDuration:n,muteDuration:s,beginDuration:h,endDuration:v,volume:o,waveType:l}}},he=r.FadeInOut=function(e,t,r){for(var a=t/1e3*(r||1),n=0;n<a;n++)e[n]*=n/a;for(var i=e.length,n=~~(i-a);n<i;n++)e[n]*=(i-n)/a};r.GetExamples=function(){return{DFH:{name:"东方红",get:function(e){return r({sampleRate:e,meterDuration:1e3,timbre:3,texts:"5 5,6|2-|1 1,6.|2-|5 5|6,1' 6,5|1 1,6.|2-"})}},HappyBirthday:{name:ue("QGsW::祝你生日快乐"),get:function(e){return r({sampleRate:e,meterDuration:450,timbre:4,waveType:"triangle",volume:.15,texts:"5.,5. 6. 5.|1 7.-|5.,5. 6. 5.|2 1-|5.,5. 5 3|1 7. 6.|4*,4_ 3 1|2 1-"})}},LHC:{name:"兰花草（洒水版）",get:function(e){return r({sampleRate:e,meterDuration:650,timbre:4,texts:"6.,3 3,3|3* 2_|1*,2_ 1,7.|6.-|6,6 6,6|6* 5_|3_,5_,5 5,4|3-|3,3_,6_ 6,5|3* 2_|1*,2_ 1,7.|6. 3.|3.,1 1,7.|6.* 2__,3__|2*,1_ 7._,7._,5.|6.-"})}},ForElise:{name:ue("emJR::致爱丽丝"),get:function(e){return r({sampleRate:e,meterDuration:550,muteDuration:20,timbre:6,texts:"3',2'|3',2' 3',7 2',1'|6 0,1 3,6|7 0,3 5,7|1' 0 3',2'|3',2' 3',7 2',1'|6 0,1 3,6|7 0,3 1',7|6 0,7 1',2'|3' 0,5 4',3'|2' 0,4 3',2'|1' 0,3 2',1'|7"})}},Canon_Right:{name:ue("GsYy::卡农-右手简谱"),get:function(e){return r({sampleRate:e,meterDuration:700,texts:"1',7 1',3 5 6,7|1' 3' 5',3' 5',6'|4',3' 2',4' 3',2' 1',7|      7 1',2'|5',3'_,4'_ 5',3'_,4'_ 5',5,6,7 1',2',3',4'|3',1'_,2'_ 3',3_,4_ 5,6,5,4 5,1',7,1'|6,1'_,7_ 6,5_,4_ 5,4,3,4 5,6,7,1'|6,1'_,7_ 1',7_,6_ 7,6,7,1' 2'_,1'_,7|1'-"})}},Canon:{name:ue("bSFZ::卡农"),get:function(e){return"3'---|2'---|1'---|7---|","1'---|7---|6---|5---|","5---|5---|3---|3---|","R[0.3] 1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|","6---|5---|6---|7---|","4---|3---|4---|5---|","1---|1---|1---|2---|","4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5.. 2. 5. 7.|","3'---|2'---|1'---|7---|","1'---|7---|6---|5---|","5---|5---|3---|3-- 5'|","1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|","4' 3' 2' 4'|3' 2' 1' 5|6- 6 1'|7 1' 2'-|","4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5.. 2. 5. 7.|","0---|0---|0---|0---|","0---|0---|0---|0---|","3',5 1'_ 5' 5_ 3'|3' 4' 3' 2'|1',3 6_ 3' 3_ 1'|1' 2' 1' 7|","1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|","0---|0---|0---|0---|","0---|0---|0---|0---|","6,1 4_ 1' 1_ 6|5,1 3_ 1' 1_ 5|6,1 4_ 1' 1_ 6|7 7 1' 2'|","4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5..,5. 5..,5. 6..,6. 6..,6.|","0---|0---|0---|0---|","0---|0---|0---|0---|",r({sampleRate:e,meterDuration:500,texts:["3'---|2'---|1'---|7---|6---|5---|6---|7---|3'---|2'---|1'---|7---|4' 3' 2' 4'|3' 2' 1' 5|6- 6 1'|7 1' 2'-|3',5 1'_ 5' 5_ 3'|3' 4' 3' 2'|1',3 6_ 3' 3_ 1'|1' 2' 1' 7|6,1 4_ 1' 1_ 6|5,1 3_ 1' 1_ 5|6,1 4_ 1' 1_ 6|7 7 1' 2'|","1'---|7---|6---|5---|4---|3---|4---|5---|1'---|7---|6---|5---|4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5.. 2. 5. 7.|1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5..,5. 5..,5. 6..,6. 6..,6.|","5---|5---|3---|3---|1---|1---|1---|2---|5---|5---|3---|3-- 5'|0---|0---|0---|0---|0---|0---|0---|0---|0---|0---|0---|0---|","R[0.3] 1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5.. 2. 5. 7.|1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|0---|0---|0---|0---|0---|0---|0---|0---|0---|0---|0---|0---|"]})}}}},se.NMN2PCM=r}(r,0,a.$T)}();
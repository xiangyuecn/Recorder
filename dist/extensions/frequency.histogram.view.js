/*
录音
https://github.com/xiangyuecn/Recorder
src: extensions/frequency.histogram.view.js
*/
!function(){"use strict";var t=function(t){return new e(t)},e=function(t){var e=this,r={scale:2,fps:20,lineCount:30,widthRatio:.6,spaceWidth:0,minHeight:0,position:-1,stripeEnable:!0,stripeHeight:3,stripeMargin:6,fallDuration:1e3,stripeFallDuration:3500,linear:[0,"rgba(0,187,17,1)",.5,"rgba(255,215,0,1)",1,"rgba(255,102,0,1)"],stripeLinear:null,shadowBlur:0,shadowColor:"#bbb",stripeShadowBlur:-1,stripeShadowColor:"",onDraw:function(t,e){}};for(var a in t)r[a]=t[a];e.set=t=r;var i=t.elem;i&&("string"==typeof i?i=document.querySelector(i):i.length&&(i=i[0])),i&&(t.width=i.offsetWidth,t.height=i.offsetHeight);var o=t.scale,n=t.width*o,l=t.height*o,h=e.elem=document.createElement("div"),s=["","transform-origin:0 0;","transform:scale("+1/o+");"];h.innerHTML='<div style="width:'+t.width+"px;height:"+t.height+'px;overflow:hidden"><div style="width:'+n+"px;height:"+l+"px;"+s.join("-webkit-")+s.join("-ms-")+s.join("-moz-")+s.join("")+'"><canvas/></div></div>';var f=e.canvas=h.querySelector("canvas");e.ctx=f.getContext("2d");if(f.width=n,f.height=l,i&&(i.innerHTML="",i.appendChild(h)),!Recorder.LibFFT)throw new Error("需要lib.fft.js支持");e.fft=Recorder.LibFFT(1024),e.lastH=[],e.stripesH=[]};e.prototype=t.prototype={genLinear:function(t,e,r,a){for(var i=t.createLinearGradient(0,r,0,a),o=0;o<e.length;)i.addColorStop(e[o++],e[o++]);return i},input:function(t,e,r){var a=this;a.sampleRate=r,a.pcmData=t,a.pcmPos=0,a.inputTime=Date.now(),a.schedule()},schedule:function(){var t=this,e=t.set,r=Math.floor(1e3/e.fps);t.timer||(t.timer=setInterval(function(){t.schedule()},r));var a=Date.now(),i=t.drawTime||0;if(a-t.inputTime>1.3*e.stripeFallDuration)return clearInterval(t.timer),void(t.timer=0);if(!(a-i<r)){t.drawTime=a;for(var o=t.fft.bufferSize,n=t.pcmData,l=t.pcmPos,h=new Int16Array(o),s=0;s<o&&l<n.length;s++,l++)h[s]=n[l];t.pcmPos=l;var f=t.fft.transform(h);t.draw(f,t.sampleRate)}},draw:function(t,e){var r=this,a=r.set,i=r.ctx,o=a.scale,n=a.width*o,l=a.height*o,h=a.lineCount,s=r.fft.bufferSize,f=a.position,d=Math.abs(a.position),p=1==f?0:l,c=l;d<1&&(p=c/=2,c=Math.floor(c*(1+d)),p=Math.floor(0<f?p*(1-d):p*(1+d)));for(var u=r.lastH,w=r.stripesH,g=Math.ceil(c/(a.fallDuration/(1e3/a.fps))),v=Math.ceil(c/(a.stripeFallDuration/(1e3/a.fps))),m=a.stripeMargin*o,M=1<<(Math.round(Math.log(s)/Math.log(2)+3)<<1),b=Math.log(M)/Math.log(10),L=20*Math.log(32767)/Math.log(10),y=s/2,S=Math.min(y,Math.floor(5e3*y/(e/2))),C=S==y,H=C?h:Math.round(.8*h),R=S/H,D=C?0:(y-S)/(h-H),x=0,F=0;F<h;F++){var T=Math.ceil(x);x+=F<H?R:D;for(var B=Math.min(Math.ceil(x),y),j=0,E=T;E<B;E++)j=Math.max(j,Math.abs(t[E]));var q=M<j?Math.floor(17*(Math.log(j)/Math.log(10)-b)):0,z=c*Math.min(q/L,1);u[F]=(u[F]||0)-g,z<u[F]&&(z=u[F]),z<0&&(z=0),u[F]=z;var I=w[F]||0;if(z&&I<z+m)w[F]=z+m;else{var P=I-v;P<0&&(P=0),w[F]=P}}i.clearRect(0,0,n,l);var W=r.genLinear(i,a.linear,p,p-c),k=a.stripeLinear&&r.genLinear(i,a.stripeLinear,p,p-c)||W,A=r.genLinear(i,a.linear,p,p+c),G=a.stripeLinear&&r.genLinear(i,a.stripeLinear,p,p+c)||A;i.shadowBlur=a.shadowBlur*o,i.shadowColor=a.shadowColor;var V=a.widthRatio,J=a.spaceWidth*o;0!=J&&(V=(n-J*(h+1))/n);for(var K=Math.max(1*o,Math.floor(n*V/h)),N=(n-h*K)/(h+1),O=a.minHeight*o,Q=(F=0,0);F<h;F++)Q+=N,X=Math.floor(Q),z=Math.max(u[F],O),0!=p&&(Y=p-z,i.fillStyle=W,i.fillRect(X,Y,K,z)),p!=l&&(i.fillStyle=A,i.fillRect(X,p,K,z)),Q+=K;if(a.stripeEnable){var U=a.stripeShadowBlur;i.shadowBlur=(-1==U?a.shadowBlur:U)*o,i.shadowColor=a.stripeShadowColor||a.shadowColor;var X,Y,Z=a.stripeHeight*o;for(F=0,Q=0;F<h;F++)Q+=N,X=Math.floor(Q),z=w[F],0!=p&&((Y=p-z-Z)<0&&(Y=0),i.fillStyle=k,i.fillRect(X,Y,K,Z)),p!=l&&(l<(Y=p+z)+Z&&(Y=l-Z),i.fillStyle=G,i.fillRect(X,Y,K,Z)),Q+=K}a.onDraw(t)}},Recorder.FrequencyHistogramView=t}();